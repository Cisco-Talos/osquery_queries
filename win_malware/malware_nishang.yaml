malware_nishang:
  query: 'SELECT script_path, script_text, DATETIME(time, "unixepoch", "UTC") AS
    creation_time FROM powershell_events WHERE regex_match(script_text,  "New-Object\s+System\.Net\.Sockets\.TCPClient.+.GetStream\s*\(\s*\).*\[\s*byte\s*\[\s*\]\s*\].*0\.\.65535\|:ASCII\)\.GetBytes.+.Write\s*\(.+.Flush\s*\(\s*\)\s*\}.+.Close\s*\(\s*\)",0); '
  interval: 86400
  snapshot: true
  description: A powershell process known to the Nishang backdoor was detected. The Nishang post-exploitation framework is currently being used by malicious actors after exploiting Microsoft exchange servers through unpatched vulnerabilities according to Microsoft.
  references:
  - 'https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/'
  mitre_tactics:
  - Persistence: TA0003
  mitre_techniques:
  - Remote Access Tools: T1219
  - Process Injection: T1055
  - Exploitation for Credential Access: T1212
  platform:
  - windows
